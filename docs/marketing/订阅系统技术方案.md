# 订阅系统技术方案

> 配套文档：[订阅定价与裂变策略](./订阅定价与裂变策略.md)

## 现状

- 用户注册 → 输入激活码 → `activated: true` → 永久使用全部功能
- 激活码集合 `TT_activation_codes`，6位随机码，绑定最多3台设备
- 用户集合 `TT_users` 无任何订阅字段
- 无功能门控逻辑

## 目标架构

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   小红书SKU   │     │  产品内购买   │     │  邀请奖励    │
│  (激活码渠道) │     │  (支付渠道)   │     │  (裂变渠道)  │
└──────┬───────┘     └──────┬───────┘     └──────┬───────┘
       │                    │                    │
       ▼                    ▼                    ▼
┌─────────────────────────────────────────────────────────┐
│              订阅状态写入（统一入口）                      │
│         修改 TT_users.plan / planExpiry                  │
└─────────────────────────┬───────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│              功能门控（统一检查）                          │
│         前端 UI 隐藏 + 后端云函数拦截                     │
└─────────────────────────────────────────────────────────┘
```

核心原则：**激活码/支付/邀请只是入口，用户身上的订阅状态才是唯一真相。**

---

## 一、数据库变更

### 1.1 `TT_users` 新增字段

```javascript
{
  // --- 现有字段保持不变 ---
  activated: true,
  activationCode: "A3B7K9",

  // --- 新增订阅字段 ---
  plan: "basic",              // "basic" | "pro"
  planExpiry: null,           // Date | null（null = 永久）
  planSource: null,           // "redeem" | "purchase" | "referral" | "legacy"
  planActivatedAt: null,      // 首次开通时间
  planHistory: [],            // 订阅变更历史（可选，用于客服排查）
}
```

**planHistory 条目结构：**
```javascript
{
  action: "activate",         // "activate" | "renew" | "extend" | "expire"
  plan: "pro",
  duration: 365,              // 天数，0 = 永久
  source: "redeem",           // 来源
  sourceDetail: "A3B7K9",     // 激活码/订单号/邀请人ID
  timestamp: "2026-02-19T..."
}
```

### 1.2 `TT_activation_codes` 新增字段

```javascript
{
  // --- 现有字段保持不变 ---
  code: "A3B7K9",
  used: false,
  usedBy: null,

  // --- 新增字段 ---
  plan: "pro",               // 该激活码对应的版本
  duration: 365,              // 天数：180 / 365 / 0（永久）
  source: "xiaohongshu",     // 渠道来源，便于统计
  batchTag: "xhs-年版-02月", // 批次标签（替代原 batchName，更灵活）
}
```

### 1.3 老数据兼容

现有已使用的激活码没有 `plan` / `duration` 字段。处理方式：

- 所有 **已激活的老用户** 一次性写入 `plan: "pro"`, `planSource: "legacy"`
- `planExpiry` 按激活码的 `expiresAt` 或统一设为激活后一年
- 没有 `plan` 字段的用户，代码层面 fallback 为 `"pro"`（过渡期兼容）

---

## 二、小红书 SKU 与激活码映射

### 2.1 SKU 设置

| 小红书 SKU 名称 | 价格 | 激活码参数 | 说明 |
|----------------|------|-----------|------|
| 基础版 | ¥0.9 | `plan: "basic", duration: 0` | 获客入口，拿手机号+加微信 |
| 会员版·学期版 | ¥19.9 | `plan: "pro", duration: 180` | 价格锚点 |
| 会员版·年版 ⭐最划算 | ¥29.9 | `plan: "pro", duration: 365` | 主推款 |
| 会员版·创始人买断 | ¥99 | `plan: "pro", duration: 0` | 限量，含现有会员功能 |

> ¥0.9 基础版的 `duration: 0` 表示永久（free 版无到期概念）。
> ¥99 创始人买断的 `duration: 0` 也表示永久（pro 版永不过期）。两者通过 `plan` 字段区分。

### 2.2 激活码生成改造

`TT_activation_admin` 云函数的 `generate` action 新增参数：

```javascript
// 请求参数
{
  action: "generate",
  count: 50,
  batchTag: "xhs-年版-02月",
  plan: "pro",          // 新增：版本
  duration: 365,         // 新增：天数
  source: "xiaohongshu", // 新增：渠道
  expiresAt: null        // 现有：激活码本身的有效期
}

// 生成的每条记录
{
  code: "X7K9M2",
  plan: "pro",
  duration: 365,
  source: "xiaohongshu",
  batchTag: "xhs-年版-02月",
  used: false,
  // ...其他现有字段
}
```

### 2.3 后台管理页面调整

激活码管理页新增：
- 生成时选择「版本」和「时长」下拉框
- 列表中显示版本/时长标签
- 筛选器增加按版本/渠道筛选

---

## 三、激活流程改造

### 3.1 `TT_auth_activate` 改造

```
现有流程：
  验证码 → 标记 activated: true → 创建 Session

新流程：
  验证码 → 标记 activated: true
         → 读取激活码的 plan/duration
         → 计算 planExpiry
         → 写入 plan + planExpiry + planSource
         → 记录 planHistory
         → 创建 Session（含 plan 信息）
```

**planExpiry 计算逻辑：**
```javascript
function calcExpiry(duration, baseDate = new Date()) {
  if (duration === 0) return null  // 永久
  const expiry = new Date(baseDate)
  expiry.setDate(expiry.getDate() + duration)
  return expiry
}
```

**续费叠加逻辑（用于后续邀请奖励/续费场景）：**
```javascript
function extendExpiry(currentExpiry, daysToAdd) {
  // 如果已经是永久，不变
  if (currentExpiry === null) return null
  // 如果已过期，从今天开始算
  const base = currentExpiry > new Date() ? currentExpiry : new Date()
  const newExpiry = new Date(base)
  newExpiry.setDate(newExpiry.getDate() + daysToAdd)
  return newExpiry
}
```

### 3.2 新用户注册流程变更

**两条激活路径并行**——用户注册后，通过激活码或微信支付完成激活：

```
路径1（小红书渠道）：
  注册 → 输入激活码 → 激活（拿到手机号+微信）

路径2（产品内/分享渠道）：
  注册 → 微信支付 ¥0.9起 → 自动激活（联系方式后续再收集）

路径3（已登录用户升级）：
  基础版用户 → 输入会员版激活码 / 微信支付升级 → plan 升为 pro
```

**路径1：激活码激活（现有流程改造）**

`TT_auth_activate` 根据激活码的 `plan` 字段写入不同状态：
```javascript
// 基础版激活码（¥0.9）
{ plan: "basic", planExpiry: null, planSource: "redeem" }

// 会员版激活码（¥19.9起）
{ plan: "pro", planExpiry: calcExpiry(duration), planSource: "redeem" }
```

**路径2：微信支付激活（新增）**

新增云函数 `TT_payment_callback`，微信支付成功后回调写入：
```javascript
// 基础版支付（¥0.9）
{ activated: true, plan: "basic", planExpiry: null, planSource: "purchase" }

// 会员版支付（¥19.9起）
{ activated: true, plan: "pro", planExpiry: calcExpiry(duration), planSource: "purchase" }
```

> **注意**：`TT_auth_register` 仍然是 `activated: false`。未付费/未输入激活码的用户无法使用产品。

### 3.3 `TT_auth_verify` 返回订阅信息

```javascript
// 返回值新增
{
  ok: true,
  username: "teacher01",
  role: "main",
  nickname: "张老师",
  plan: "pro",                // 新增
  planExpiry: "2027-02-19",   // 新增（null = 永久）
  planExpired: false,         // 新增（后端计算，前端直接用）
  // ...其他现有字段
}
```

**过期检测逻辑：**
```javascript
function isPlanActive(user) {
  if (user.plan === "basic") return true
  if (user.planExpiry === null) return true  // 永久
  return new Date(user.planExpiry) > new Date()
}
```

当 pro 用户过期时：`plan` 保持 `"pro"` 不变，`planExpired: true`，前端据此展示续费引导而非直接降级体验。

---

## 四、功能门控

### 4.1 功能权限矩阵

> 与 [订阅定价与裂变策略](./订阅定价与裂变策略.md) 中的功能划分保持一致。

**基础版包含（¥0.9，永久可用）：**

| 功能 | 基础(basic) | 门控说明 |
|------|-----------|---------|
| 班级管理 | 1个班级，最多50名学生 | 后端：TT_class_upsert / TT_student_upsert |
| 学生增删改 + Excel导入 | ✅ | 无门控 |
| 幻兽养成 | 30只基础幻兽（梦幻系15 + 热血系15） | 前端：BeastPickerModal |
| 1-10级进化系统 | ✅ | 无门控 |
| 徽章收集 | ✅ | 无门控 |
| 积分规则（加分/扣分） | ✅ | 无门控 |
| 批量加减分 | ✅ | 无门控 |
| 积分撤回 | ✅ | 无门控 |
| 历史记录查看 | 最近90天 | 后端：TT_record_list 加时间过滤 |
| 个人荣誉榜 | ✅ | 无门控 |

**会员版解锁（¥19.9起，限时/永久）：**

| 功能 | 门控位置 |
|------|---------|
| **课堂工具** | |
| 随机点名 | 前端门控 + 后端（规划中） |
| 静音挑战（噪音监测） | 前端门控 |
| 考勤管理（规划中） | 前端门控 |
| 未来新增的课堂工具 | 前端门控 |
| **班级管理升级** | |
| 不限班级数量 | 后端：TT_class_upsert |
| 不限学生人数 | 后端：TT_student_upsert |
| 子账号管理 | 后端：TT_subaccount_manage |
| **幻兽养成升级** | |
| 全部60只幻兽 | 前端：BeastPickerModal |
| 幻兽装饰品系统（规划中） | 前端门控 |
| **数据与记录** | |
| 历史记录不限时间 | 后端：TT_record_list 取消时间过滤 |
| 周/月统计概览 | 后端：TT_record_summary |
| 规则使用统计 | 后端：TT_record_summary |
| CSV数据导出 | 后端：TT_record_export |
| **协作与分享** | |
| 小卖部系统 | 后端：TT_shop_save / TT_shop_redeem |
| 小组PK排名 | 后端：TT_group_manage |
| 班级/学生分享链接 | 后端：TT_share_create |
| 家长查看（规划中） | 后端（规划中） |

### 4.2 后端门控实现

新增公共模块 `_shared/planGuard.js`（或直接在各云函数内联）：

```javascript
/**
 * 检查用户是否有 pro 权限
 * @param {object} db - 数据库实例
 * @param {string} userId - 用户ID
 * @returns {{ allowed: boolean, plan: string, expired: boolean }}
 */
async function checkPlan(db, userId) {
  const { data: rows } = await db.collection("TT_users")
    .where({ _id: userId })
    .limit(1)
    .get()

  const user = rows[0]?.data || rows[0]
  if (!user) return { allowed: false, plan: "basic", expired: false }

  const plan = user.plan || "pro"  // 兼容老用户（无 plan 字段 = pro）
  if (plan === "basic") return { allowed: false, plan, expired: false }

  // pro 用户检查过期
  if (user.planExpiry === null) return { allowed: true, plan, expired: false }
  const expired = new Date(user.planExpiry) <= new Date()
  return { allowed: !expired, plan, expired }
}
```

**在受限云函数中使用：**
```javascript
// 例：TT_class_upsert 中检查班级数量限制
const { allowed } = await checkPlan(db, userId)
if (!allowed) {
  // 检查当前班级数
  const { data: classes } = await db.collection("TT_classes")
    .where(_.or([{ userId }, { "data.userId": userId }]))
    .limit(2)
    .get()
  if (classes.length >= 1 && !isEditing) {
    return { error: "FREE_PLAN_LIMIT", message: "基础版最多创建1个班级，升级会员版解锁更多" }
  }
}
```

### 4.3 前端门控实现

**Auth Store 新增字段：**
```typescript
interface AuthState {
  // ...现有字段
  plan: "basic" | "pro"
  planExpiry: string | null
  planExpired: boolean
  isPro: () => boolean  // 计算属性：plan === "pro" && !planExpired
  isBasic: () => boolean  // plan === "basic"
}
```

**门控 UI 模式：**
```
方案：功能入口保留可见，点击时弹出升级提示

原因：
- 让 free 用户知道有这些功能存在（种草）
- 比完全隐藏更能激发升级欲望
- 实现简单，不需要大量条件渲染
```

**通用升级提示组件：**
```tsx
// <ProFeatureGate> 包裹受限功能的入口
<ProFeatureGate feature="小卖部">
  <StoreButton />
</ProFeatureGate>

// 点击时如果非 pro，弹出升级弹窗而非执行操作
```

---

## 五、Session 与缓存同步

### 5.1 Session 新增字段

```javascript
// TT_sessions 新增
{
  plan: "pro",
  planExpiry: "2027-02-19T...",
}
```

### 5.2 订阅状态变更时的 Session 刷新

当用户升级/续费后，需要刷新当前 Session 中的 plan 信息：

- **方案 A**：升级后前端重新调用 `TT_auth_verify`，该接口每次都读 `TT_users` 最新状态 ✅
- 方案 B：升级后清除 Session 强制重新登录（体验差）

选择方案 A，`TT_auth_verify` 已有读取用户最新数据的逻辑，只需补充返回 plan 字段即可。

前端 TTL 缓存（`cloudApi.ts`）中 `authVerify` 不走缓存或设置极短 TTL，确保 plan 变更后能及时感知。

---

## 六、老用户迁移方案

### 6.1 迁移脚本

一次性执行的迁移云函数 `TT_migrate_plans`：

```javascript
// 1. 查出所有已激活用户
// 2. 对每个用户：
//    - 如果已有 plan 字段，跳过
//    - 读取关联的 activation_code 的 expiresAt
//    - 设置 plan: "pro", planSource: "legacy"
//    - planExpiry: 激活码 expiresAt || 激活时间 + 365天
//    - 写入 planHistory 初始记录
```

### 6.2 兼容期策略

代码中所有读取 `plan` 的地方，fallback 逻辑：
```javascript
const plan = user.plan || "pro"  // 没有 plan 字段的老用户默认 pro
```

迁移完成并确认无误后，移除 fallback。

---

## 七、改动清单

### 云函数改动

| 云函数 | 改动内容 | 优先级 |
|--------|---------|--------|
| `TT_auth_register` | 新增默认 plan: "basic"（仍需激活码才能用） | P0 |
| `TT_auth_activate` | 读取激活码 plan/duration，写入用户订阅状态 | P0 |
| `TT_auth_verify` | 返回 plan/planExpiry/planExpired | P0 |
| `TT_activation_admin` | generate 支持 plan/duration/source 参数 | P0 |
| `TT_class_upsert` | 基础版班级数限制 | P1 |
| `TT_student_upsert` | 基础版学生数限制 | P1 |
| `TT_subaccount_manage` | pro 门控 | P1 |
| `TT_shop_save` | pro 门控 | P1 |
| `TT_shop_redeem` | pro 门控 | P1 |
| `TT_group_manage` | pro 门控 | P1 |
| `TT_record_summary` | pro 门控 | P1 |
| `TT_record_export` | pro 门控 | P1 |
| `TT_share_create` | pro 门控 | P1 |
| `TT_record_list` | 基础版限制查询最近90天 | P1 |
| `TT_migrate_plans` | 新增：老用户迁移脚本 | P0 |
| `TT_payment_create` | 新增：创建微信支付订单 | P0 |
| `TT_payment_callback` | 新增：微信支付回调，写入订阅状态 | P0 |

### 前端改动

| 文件/组件 | 改动内容 | 优先级 |
|----------|---------|--------|
| `authStore.ts` | 新增 plan/planExpiry/isPro | P0 |
| `types/api.ts` | 新增订阅相关类型 | P0 |
| `Auth.tsx` | 注册后引导到支付/激活页（未激活用户两种选择） | P0 |
| `Activate.tsx` | 支持已登录的基础版用户输入会员版激活码升级 | P0 |
| `PaymentPage.tsx` | 新增：产品内支付页（选方案 → 微信支付 → 自动激活） | P0 |
| `ProFeatureGate.tsx` | 新增：通用升级门控组件 | P1 |
| `UpgradeModal.tsx` | 新增：升级提示弹窗（展示方案对比 + 购买方式） | P1 |
| `Settings.tsx` | 显示当前版本信息、到期时间 | P1 |
| `BeastPickerModal.tsx` | 基础版限制30只幻兽 | P1 |
| `Home.tsx` / 侧边栏 | 基础版显示升级入口 | P2 |

### 新增文件

| 文件 | 说明 |
|------|------|
| `app/cloudfunctions/TT_migrate_plans/` | 老用户迁移脚本（一次性） |
| `app/cloudfunctions/TT_payment_create/` | 创建微信支付订单 |
| `app/cloudfunctions/TT_payment_callback/` | 微信支付回调处理 |
| `app/src/routes/PaymentPage.tsx` | 产品内支付页面 |
| `app/src/components/ProFeatureGate.tsx` | 通用门控组件 |
| `app/src/components/UpgradeModal.tsx` | 升级弹窗 |
| `app/src/config/planLimits.ts` | 版本功能限制常量 |

---

## 八、实施节奏

### 第一步：基础设施（订阅状态 + 激活码改造）

1. `TT_users` 新增 plan 相关字段
2. `TT_activation_admin` 支持生成带 plan/duration 的激活码
3. `TT_auth_activate` 写入用户订阅状态
4. `TT_auth_verify` 返回 plan 信息
5. 前端 authStore 存储 plan
6. 老用户迁移脚本

> 完成后即可在小红书上架4个 SKU，现有用户无感。

### 第二步：产品内微信支付

1. 对接微信支付（`TT_payment_create` + `TT_payment_callback`）
2. 产品内支付页面（选方案 → 微信扫码 → 自动激活）
3. 注册后引导：有激活码 → 输入激活码 / 没有 → 去支付页

> 完成后分享/搜索来的用户也能直接付费进入，不依赖小红书渠道。

### 第三步：功能门控

1. 后端各云函数加 plan 检查
2. 前端 ProFeatureGate + UpgradeModal
3. Activate.tsx 支持已登录用户输入升级码

> 完成后基础版用户有功能限制，可通过激活码或微信支付升级。

### 第四步：邀请裂变（后续）

1. 邀请码生成与绑定
2. 被邀请人付费 → 双方时长奖励
3. 个人中心邀请进度页

---

## 九、风险与注意事项

| 风险 | 应对 |
|------|------|
| 老用户迁移出错导致无法使用 | `plan` fallback 为 `"pro"`，迁移期间老用户不受影响 |
| 基础版体验太差导致流失 | 核心功能（积分、课堂工具、历史记录）全部开放，确保可用性 |
| 激活码被转卖/滥用 | 保留现有设备绑定限制（3台），plan 信息在码上不可见 |
| pro 过期后数据丢失 | 过期不删数据，只限制功能入口，续费后立刻恢复 |
| 前后端 plan 状态不一致 | 后端为准，前端通过 authVerify 同步，受限操作后端二次校验 |
