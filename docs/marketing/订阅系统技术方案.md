# 订阅系统技术方案

> 配套文档：[订阅定价与裂变策略](./订阅定价与裂变策略.md)

## 现状

- 用户注册 → 输入激活码 → `activated: true` → 永久使用全部功能
- 激活码集合 `TT_activation_codes`，6位随机码，绑定最多3台设备
- 用户集合 `TT_users` 无任何订阅字段
- 无功能门控逻辑

## 目标架构

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   小红书SKU   │     │  产品内注册   │     │  邀请奖励    │
│  (¥0.1体验)  │     │  (免费试用)   │     │  (裂变渠道)  │
└──────┬───────┘     └──────┬───────┘     └──────┬───────┘
       │                    │                    │
       ▼                    ▼                    ▼
┌─────────────────────────────────────────────────────────┐
│              订阅状态写入（统一入口）                      │
│     修改 TT_users.plan / planExpiry / trialExpiry        │
└─────────────────────────┬───────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│              功能门控（统一检查）                          │
│         前端 UI 隐藏 + 后端云函数拦截                     │
└─────────────────────────────────────────────────────────┘
```

**用户生命周期：**
```
注册 → plan: "trial", trialExpiry: 30天后
     → 30天全功能使用（带「会员体验」标识）
     → 到期：TT_auth_verify 检测过期 → 返回 plan: "basic"
     → 基础版受限使用（已有数据不动，只限制新增操作）
     → 付费升级 → plan: "pro", planExpiry: 对应时长
```

核心原则：**注册即试用，到期自动降级，付费即升级。后端 `TT_auth_verify` 是状态真相的唯一出口。**

---

## 一、数据库变更

### 1.1 `TT_users` 新增字段

```javascript
{
  // --- 现有字段保持不变 ---
  activated: true,
  activationCode: "A3B7K9",

  // --- 新增订阅字段 ---
  plan: "trial",              // "trial" | "basic" | "pro"
  trialExpiry: Date,          // 试用到期时间（注册时设置，30天后）
  planExpiry: null,           // Date | null（pro 的到期时间，null = 永久买断）
  planSource: null,           // "trial" | "redeem" | "purchase" | "referral" | "legacy"
  planActivatedAt: null,      // 首次开通 pro 时间
  planHistory: [],            // 订阅变更历史（可选，用于客服排查）
}
```

**plan 值说明：**
| plan | 含义 | 来源 |
|------|------|------|
| `"trial"` | 试用期，全功能 | 注册自动获得 |
| `"basic"` | 基础版，受限功能 | 试用到期后 TT_auth_verify 返回 |
| `"pro"` | 会员版，全功能 | 付费/兑换/邀请奖励 |

> **重要**：`trial` 到期后，数据库中 `plan` 不改写为 `"basic"`。而是 `TT_auth_verify` 在返回时检测 `trialExpiry`，如果过期则返回 `effectivePlan: "basic"`。这样避免定时任务写入，简化逻辑。

**planHistory 条目结构：**
```javascript
{
  action: "activate",         // "activate" | "renew" | "extend" | "expire"
  plan: "pro",
  duration: 365,              // 天数，0 = 永久
  source: "redeem",           // 来源
  sourceDetail: "A3B7K9",     // 激活码/订单号/邀请人ID
  timestamp: "2026-02-19T..."
}
```

### 1.2 `TT_activation_codes` 角色变更

激活码从"准入门槛"变为"赠送会员时长"兑换码：

```javascript
{
  // --- 现有字段保持不变 ---
  code: "A3B7K9",
  used: false,
  usedBy: null,

  // --- 新增字段 ---
  plan: "pro",               // 该兑换码对应的版本（固定为 pro）
  duration: 365,              // 天数：180 / 365 / 0（永久买断）
  source: "xiaohongshu",     // 渠道来源，便于统计
  batchTag: "xhs-年版-02月", // 批次标签
}
```

> 小红书 ¥0.1 免费体验装不需要激活码，直接给注册链接即可。只有 ¥9.9/¥19.9/¥59.9 的会员版 SKU 需要兑换码。

### 1.3 老数据兼容

现有已使用的激活码没有 `plan` / `duration` 字段。处理方式：

- 所有 **已激活的老用户** 一次性写入 `plan: "pro"`, `planSource: "legacy"`
- `planExpiry` 统一设为激活后一年
- 没有 `plan` 字段的用户，代码层面 fallback 为 `"pro"`（过渡期兼容）

---

## 二、小红书 SKU 与激活码映射

### 2.1 SKU 设置

| 小红书 SKU 名称 | 首发价 | 涨价后 | 激活码参数 | 说明 |
|----------------|--------|--------|-----------|------|
| 免费体验装 | ¥0.1 | ¥0.1 | 无需激活码，发注册链接 | 拿联系方式 + 30天全功能试用 |
| 会员版·学期版 | ¥9.9 | ¥19.9 | `plan: "pro", duration: 180` | 价格锚点 |
| 会员版·年版 ⭐ | ¥19.9 | ¥29.9 | `plan: "pro", duration: 365` | 主推款 |
| 会员版·创始人买断 | ¥59.9 | ¥69 | `plan: "pro", duration: 0` | 限量，永久会员 |

> 免费体验装 ¥0.1 的目的是走订单流拿到手机号+加微信，用户拿到的是注册链接，注册后和产品内免费注册一样是30天试用。
> 3个会员版 SKU 的激活码直接跳过试用，注册+兑换后立即开通对应时长的会员。

### 2.2 激活码生成改造

`TT_activation_admin` 云函数的 `generate` action 新增参数：

```javascript
// 请求参数
{
  action: "generate",
  count: 50,
  batchTag: "xhs-年版-02月",
  plan: "pro",          // 新增：版本（固定为 pro）
  duration: 365,         // 新增：天数
  source: "xiaohongshu", // 新增：渠道
  expiresAt: null        // 现有：激活码本身的有效期
}
```

### 2.3 后台管理页面调整

激活码管理页新增：
- 生成时选择「时长」下拉框（180天 / 365天 / 永久）
- 列表中显示时长标签
- 筛选器增加按渠道筛选

---

## 三、注册与激活流程改造

### 3.1 新用户注册流程

```
新流程（产品内免费注册）：
  注册 → activated: true
       → plan: "trial"
       → trialExpiry: new Date() + 30天
       → planSource: "trial"
       → 创建 Session（含 plan 信息）
       → 进入产品，全功能可用
```

> **关键变更**：注册不再需要激活码。`TT_auth_register` 直接设置 `activated: true` + `plan: "trial"`。

### 3.2 兑换码（原激活码）流程

```
已注册用户兑换会员码：
  输入兑换码 → 验证码有效性
            → 读取码的 plan/duration
            → 计算 planExpiry（如果当前已是 pro，叠加时长）
            → 写入 plan: "pro" + planExpiry + planSource: "redeem"
            → 记录 planHistory
            → 刷新 Session
```

**planExpiry 计算逻辑：**
```javascript
function calcExpiry(duration, baseDate = new Date()) {
  if (duration === 0) return null  // 永久买断
  const expiry = new Date(baseDate)
  expiry.setDate(expiry.getDate() + duration)
  return expiry
}
```

**续费叠加逻辑（用于兑换/邀请奖励/续费）：**
```javascript
function extendExpiry(currentExpiry, daysToAdd) {
  if (currentExpiry === null) return null  // 已是永久，不变
  // 如果已过期，从今天开始算
  const base = currentExpiry > new Date() ? currentExpiry : new Date()
  const newExpiry = new Date(base)
  newExpiry.setDate(newExpiry.getDate() + daysToAdd)
  return newExpiry
}
```

### 3.3 微信支付流程（新增）

```
路径1（产品内支付升级）：
  试用期/基础版用户 → 升级入口 → 选方案 → 微信支付 → 回调写入 pro 状态

路径2（小红书会员版 SKU 直接购买）：
  未注册用户 → 注册链接 → 注册 → 输入兑换码 → 直接开通 pro
```

新增云函数 `TT_payment_create` + `TT_payment_callback`：
```javascript
// 微信支付成功回调写入
{ plan: "pro", planExpiry: calcExpiry(duration), planSource: "purchase" }
```

### 3.4 `TT_auth_verify` 返回实际状态

```javascript
// 返回值
{
  ok: true,
  username: "teacher01",
  role: "main",
  nickname: "张老师",
  plan: "trial",              // 数据库存储的原始 plan
  effectivePlan: "basic",     // 新增：实际生效的 plan（核心字段）
  trialExpiry: "2026-03-19",  // 试用到期时间
  planExpiry: null,           // pro 到期时间
  trialDaysLeft: 0,           // 试用剩余天数（-1 = 已过期）
  // ...其他现有字段
}
```

**effectivePlan 计算逻辑（TT_auth_verify 核心）：**
```javascript
function getEffectivePlan(user) {
  // 1. pro 用户：检查是否过期
  if (user.plan === "pro") {
    if (user.planExpiry === null) return "pro"  // 永久买断
    return new Date(user.planExpiry) > new Date() ? "pro" : "basic"
  }

  // 2. trial 用户：检查试用是否到期
  if (user.plan === "trial") {
    return new Date(user.trialExpiry) > new Date() ? "trial" : "basic"
  }

  // 3. basic 用户：直接返回
  return "basic"
}
```

> `effectivePlan` 是前端做功能门控的唯一依据。`trial` 和 `pro` 功能完全一致，前端只需区分 `effectivePlan === "basic"` 与否。

---

## 四、功能门控

### 4.1 功能权限矩阵

> 与 [订阅定价与裂变策略](./订阅定价与裂变策略.md) 中的功能划分保持一致。

**trial = pro = 全功能。以下矩阵只需区分 basic 与非 basic。**

**基础版（basic）功能：**

| 功能 | 基础版限制 | 门控说明 |
|------|-----------|---------|
| 班级管理 | 1个班级，最多50名学生 | 后端：TT_class_upsert / TT_student_upsert |
| 学生增删改 + Excel导入 | ✅ | 无门控 |
| 幻兽养成 | 30只基础幻兽（梦幻系15 + 热血系15） | 前端：BeastPickerModal |
| 1-10级进化系统 | ✅ | 无门控 |
| 徽章收集 | ✅ | 无门控 |
| 积分规则（加分/扣分） | ✅ | 无门控 |
| 批量加减分 | ✅ | 无门控 |
| 积分撤回 | ✅ | 无门控 |
| 历史记录查看 | 最近90天 | 后端：TT_record_list 加时间过滤 |
| 个人荣誉榜 | ✅ | 无门控 |

**会员版 / 试用期 解锁功能：**

| 功能 | 门控位置 |
|------|---------|
| **课堂工具** | |
| 随机点名 | 前端门控 + 后端（规划中） |
| 静音挑战（噪音监测） | 前端门控 |
| 考勤管理（规划中） | 前端门控 |
| 未来新增的课堂工具 | 前端门控 |
| **班级管理升级** | |
| 不限班级数量 | 后端：TT_class_upsert |
| 不限学生人数 | 后端：TT_student_upsert |
| 子账号管理 | 后端：TT_subaccount_manage |
| **幻兽养成升级** | |
| 全部60只幻兽 | 前端：BeastPickerModal |
| 幻兽装饰品系统（规划中） | 前端门控 |
| **数据与记录** | |
| 历史记录不限时间 | 后端：TT_record_list 取消时间过滤 |
| 周/月统计概览 | 后端：TT_record_summary |
| 规则使用统计 | 后端：TT_record_summary |
| CSV数据导出 | 后端：TT_record_export |
| **协作与分享** | |
| 小卖部系统 | 后端：TT_shop_save / TT_shop_redeem |
| 小组PK排名 | 后端：TT_group_manage |
| 班级/学生分享链接 | 后端：TT_share_create |
| 家长查看（规划中） | 后端（规划中） |

### 4.2 降级规则的后端实现

降级核心原则：**已有数据不动，只限制新增操作。**

```javascript
// 例：TT_class_upsert 中的降级检查
const { effectivePlan } = await checkPlan(db, userId)
if (effectivePlan === "basic" && !isEditing) {
  // 只在【新建】时检查限制，【编辑】已有班级不拦截
  const { data: classes } = await db.collection("TT_classes")
    .where(_.or([{ userId }, { "data.userId": userId }]))
    .limit(2)
    .get()
  if (classes.length >= 1) {
    return { error: "BASIC_PLAN_LIMIT", message: "基础版最多创建1个班级，升级会员版解锁更多" }
  }
}
```

### 4.3 后端门控公共模块

新增公共模块 `_shared/planGuard.js`（或直接在各云函数内联）：

```javascript
/**
 * 获取用户的实际生效 plan
 * @param {object} db - 数据库实例
 * @param {string} userId - 用户ID
 * @returns {{ effectivePlan: string, plan: string, trialDaysLeft: number }}
 */
async function checkPlan(db, userId) {
  const { data: rows } = await db.collection("TT_users")
    .where({ _id: userId })
    .limit(1)
    .get()

  const user = rows[0]?.data || rows[0]
  if (!user) return { effectivePlan: "basic", plan: "basic", trialDaysLeft: -1 }

  const plan = user.plan || "pro"  // 兼容老用户（无 plan 字段 = pro）

  if (plan === "pro") {
    if (user.planExpiry === null) return { effectivePlan: "pro", plan, trialDaysLeft: -1 }
    const expired = new Date(user.planExpiry) <= new Date()
    return { effectivePlan: expired ? "basic" : "pro", plan, trialDaysLeft: -1 }
  }

  if (plan === "trial") {
    const now = new Date()
    const expiry = new Date(user.trialExpiry)
    const daysLeft = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24))
    return { effectivePlan: daysLeft > 0 ? "trial" : "basic", plan, trialDaysLeft: daysLeft }
  }

  return { effectivePlan: "basic", plan, trialDaysLeft: -1 }
}
```

### 4.4 前端门控实现

**Auth Store 新增字段：**
```typescript
interface AuthState {
  // ...现有字段
  plan: "trial" | "basic" | "pro"
  effectivePlan: "trial" | "basic" | "pro"
  trialExpiry: string | null
  planExpiry: string | null
  trialDaysLeft: number
  isPro: () => boolean  // effectivePlan === "trial" || effectivePlan === "pro"
  isBasic: () => boolean  // effectivePlan === "basic"
}
```

**门控 UI 模式：**
```
方案：功能入口保留可见，点击时弹出升级提示

原因：
- 让 basic 用户知道有这些功能存在（种草）
- 比完全隐藏更能激发升级欲望
- 实现简单，不需要大量条件渲染
```

**通用升级提示组件：**
```tsx
// <ProFeatureGate> 包裹受限功能的入口
<ProFeatureGate feature="小卖部">
  <StoreButton />
</ProFeatureGate>

// 点击时如果 isBasic()，弹出升级弹窗而非执行操作
// 试用期用户看到「会员体验」标识，但功能正常使用
```

**试用期标识：**
```
试用期用户在使用会员功能时，入口处显示「会员体验·剩余X天」标识
目的：让用户意识到这些功能是付费功能，到期需升级
```

---

## 五、Session 与缓存同步

### 5.1 Session 新增字段

```javascript
// TT_sessions 新增
{
  plan: "trial",
  effectivePlan: "trial",  // 登录时计算
  trialExpiry: "2026-03-19T...",
  planExpiry: null,
}
```

### 5.2 订阅状态变更时的 Session 刷新

当用户升级/续费/试用到期后，需要刷新状态：

- **方案**：前端通过 `TT_auth_verify` 获取最新 `effectivePlan`，该接口每次都读 `TT_users` 最新状态并实时计算
- 前端 TTL 缓存（`cloudApi.ts`）中 `authVerify` 不走缓存或设置极短 TTL，确保 plan 变更后能及时感知
- 试用到期是"静默降级"，不需要主动通知，用户下次使用受限功能时自然发现

---

## 六、老用户迁移方案

### 6.1 迁移脚本

一次性执行的迁移云函数 `TT_migrate_plans`：

```javascript
// 1. 查出所有已激活用户（activated: true）
// 2. 对每个用户：
//    - 如果已有 plan 字段，跳过
//    - 设置 plan: "pro", planSource: "legacy"
//    - planExpiry: 激活时间 + 365天（统一赠送1年会员）
//    - trialExpiry: null（老用户不走试用流程）
//    - 写入 planHistory 初始记录
```

### 6.2 兼容期策略

代码中所有读取 `plan` 的地方，fallback 逻辑：
```javascript
const plan = user.plan || "pro"  // 没有 plan 字段的老用户默认 pro
```

迁移完成并确认无误后，移除 fallback。

---

## 七、改动清单

### 云函数改动

| 云函数 | 改动内容 | 优先级 |
|--------|---------|--------|
| `TT_auth_register` | 注册直接设 `activated: true, plan: "trial", trialExpiry: +30天` | P0 |
| `TT_auth_activate` | 改为"兑换码"流程，读取码的 plan/duration，写入 pro 状态 | P0 |
| `TT_auth_verify` | 返回 effectivePlan / trialDaysLeft / planExpiry | P0 |
| `TT_activation_admin` | generate 支持 plan/duration/source 参数 | P0 |
| `TT_class_upsert` | basic 班级数限制（只限新建，不限编辑） | P1 |
| `TT_student_upsert` | basic 学生数限制 | P1 |
| `TT_subaccount_manage` | pro 门控 | P1 |
| `TT_shop_save` | pro 门控 | P1 |
| `TT_shop_redeem` | pro 门控 | P1 |
| `TT_group_manage` | pro 门控 | P1 |
| `TT_record_summary` | pro 门控 | P1 |
| `TT_record_export` | pro 门控 | P1 |
| `TT_share_create` | pro 门控 | P1 |
| `TT_record_list` | basic 限制查询最近90天 | P1 |
| `TT_migrate_plans` | 新增：老用户迁移脚本 | P0 |
| `TT_payment_create` | 新增：创建微信支付订单 | P0 |
| `TT_payment_callback` | 新增：微信支付回调，写入 pro 状态 | P0 |

### 前端改动

| 文件/组件 | 改动内容 | 优先级 |
|----------|---------|--------|
| `authStore.ts` | 新增 plan/effectivePlan/trialDaysLeft/isPro | P0 |
| `types/api.ts` | 新增订阅相关类型 | P0 |
| `Auth.tsx` | 注册即试用，无需激活码（保留兑换码入口） | P0 |
| `Activate.tsx` | 改为"兑换码"页面，支持已注册用户兑换会员 | P0 |
| `PaymentPage.tsx` | 新增：产品内支付页（选方案 → 微信支付 → 升级） | P0 |
| `ProFeatureGate.tsx` | 新增：通用升级门控组件 | P1 |
| `UpgradeModal.tsx` | 新增：升级提示弹窗（展示方案对比 + 购买方式） | P1 |
| `TrialBadge.tsx` | 新增：试用期「会员体验·剩余X天」标识 | P1 |
| `Settings.tsx` | 显示当前版本信息、到期时间、升级入口 | P1 |
| `BeastPickerModal.tsx` | basic 限制30只幻兽 | P1 |
| `Home.tsx` / 侧边栏 | basic 显示升级入口，试用期显示倒计时 | P2 |

### 新增文件

| 文件 | 说明 |
|------|------|
| `app/cloudfunctions/TT_migrate_plans/` | 老用户迁移脚本（一次性） |
| `app/cloudfunctions/TT_payment_create/` | 创建微信支付订单 |
| `app/cloudfunctions/TT_payment_callback/` | 微信支付回调处理 |
| `app/src/routes/PaymentPage.tsx` | 产品内支付页面 |
| `app/src/components/ProFeatureGate.tsx` | 通用门控组件 |
| `app/src/components/UpgradeModal.tsx` | 升级弹窗 |
| `app/src/components/TrialBadge.tsx` | 试用期标识组件 |
| `app/src/config/planLimits.ts` | 版本功能限制常量 |

---

## 八、实施节奏

### 第一步：基础设施（注册试用 + 兑换码改造）

1. `TT_auth_register` 改为注册即 `plan: "trial"` + 30天试用
2. `TT_activation_admin` 支持生成带 plan/duration 的兑换码
3. `TT_auth_activate` 改为兑换码流程，写入 pro 状态
4. `TT_auth_verify` 返回 effectivePlan（含试用到期检测）
5. 前端 authStore 存储 effectivePlan
6. 老用户迁移脚本

> 完成后新用户免费注册即可使用，小红书上架4个 SKU。

### 第二步：产品内微信支付

1. 对接微信支付（`TT_payment_create` + `TT_payment_callback`）
2. 产品内支付页面（选方案 → 微信扫码 → 自动升级）
3. 升级入口：设置页 + 试用到期提醒

> 完成后试用到期的用户可以直接在产品内付费续命。

### 第三步：功能门控

1. 后端各云函数加 effectivePlan 检查
2. 前端 ProFeatureGate + UpgradeModal + TrialBadge
3. Activate.tsx 改为兑换码页面

> 完成后 basic 用户有功能限制，可通过兑换码或微信支付升级。

### 第四步：邀请裂变（后续）

1. 邀请码生成与绑定
2. 被邀请人付费 → 双方时长奖励
3. 个人中心邀请进度页

---

## 九、风险与注意事项

| 风险 | 应对 |
|------|------|
| 老用户迁移出错导致无法使用 | `plan` fallback 为 `"pro"`，迁移期间老用户不受影响 |
| 试用到期用户流失 | 到期前3天/1天站内提醒，降级后保留数据降低迁移成本 |
| 免费试用被滥用（多账号刷） | 不主动封堵，体验差是天然门槛（数据分散、切换麻烦） |
| 激活码被转卖/滥用 | 保留现有设备绑定限制（3台），plan 信息在码上不可见 |
| pro 过期后数据丢失 | 过期不删数据，只限制新增操作，续费后立刻恢复 |
| 前后端 plan 状态不一致 | 后端 effectivePlan 为准，前端通过 authVerify 同步，受限操作后端二次校验 |
| 降级后已有数据超限 | 保留所有已有数据，只在新增操作时检查限制 |
