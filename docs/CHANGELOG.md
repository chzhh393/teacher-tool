# 更新日志

本文件记录幻兽学院项目的版本变更历史。

## v1.0.5 (2026-02-07)

### 新增
- 小卖部商品自定义：教师可在设置页面管理商品（增删改），商品按班级隔离
  - 支持编辑图标、名称、描述、价格、库存
  - 新班级首次访问设置页时自动初始化 8 个默认商品到数据库
  - 保存设置时并行保存积分规则和商品数据
- 新建云函数 `TT_shop_save`：批量同步商品（智能增/改/删）
- 兑换自动扣减库存：`TT_shop_redeem` 增加库存检查 + `db.command.inc(-1)` 原子扣减，库存为 0 时显示"售罄"

### 变更
- `TT_shop_list` 云函数增加 `classId` 过滤，商品从全局共享改为按班级隔离
- `TT_shop_items` 数据库集合新增 `classId` 字段
- Store 页面 `shopList` 调用传入当前班级 ID
- `normalizeShopItems` 工具函数增加 `data` 嵌套解包处理

### 修复
- 修复 `AppShell.tsx` 中 `setCloudStatus` 未定义的编译错误

## v1.0.4 (2026-02-07)

### 新增
- Excel 导入学生名单：支持上传 .xlsx/.xls 文件，自动识别姓名列，预览确认后批量导入
  - 三步流程：上传文件 → 选择姓名列（自动匹配"姓名"/"名字"等关键词）→ 预览去重后确认导入
  - 支持拖拽上传，文件大小限制 5MB
  - 新增 `ExcelImportModal` 组件和 `excelParse` 工具函数
  - 新增依赖 `xlsx`（SheetJS）

## v1.0.3 (2026-02-07)

### 新增
- 幻兽进化全屏庆祝动画：加分导致进化阶段变化时（蛋→幼年→少年→成年→究极），显示白色闪光 + 发光环 + 星星粒子 + 新形态幻兽居中展示 + 「已升级!」文字提示
- 批量操作时支持连续播放多个进化动画（最多 5 个），底部显示进度圆点
- 右上角「跳过」按钮或点击任意位置可跳过动画

### 优化
- 老师设置页面保存提示改为固定在视口顶部的 toast，成功提示 2.5 秒自动消失，增加关闭按钮

### 重构
- 将 `getEvolutionStage`、`stageNames` 提取到 `app/src/utils/evolution.ts` 共享工具函数

## v1.0.2 (2026-02-06)

### 修复
- 修复 Home 页「前往创建班级」链接使用 `<a>` 导致 SPA 路由 404 的问题，改用 `<Link>`
- 修复 `TT_student_list` 云函数全表扫描导致新班级学生不显示的问题（默认 100 条限制）
- 修复 `TT_class_get`、`TT_honors_list`、`TT_record_list`、`TT_record_export`、`TT_redeem_list`、`TT_class_list` 共 6 个云函数相同的全表扫描问题，统一改为 `.where()` + `.limit(1000)`

### 新增
- 新用户创建班级后自动预置 13 条默认积分规则（9 加分 + 4 减分），数据来源于 3年3班配置
- 未领养幻兽的学生在加分/减分操作时显示 toast 提示「XX还没有领养幻兽，请先领养」，覆盖单个、批量、全班三种操作模式

### 变更
- Toast 提示位置调整为屏幕下方 1/3 处

## v1.0.1 (2026-02-06)

### 修复
- 修复激活码管理页面"已使用"状态筛选返回空结果的问题
- 将 BrowserRouter 切换为 HashRouter，解决静态托管下页面刷新 404 问题

### 变更
- 移除页面标题中的个人姓名
- 更新部署文档，补充故障排查指南

## v1.0.0 (2026-02-05)

### 功能
- **幻兽系统**：30 只幻兽，5 个进化阶段，10 个等级
- **积分系统**：加分/减分操作，积分记录追踪
- **商店系统**：积分兑换道具
- **荣誉系统**：荣誉授予与展示
- **记录系统**：操作历史查看
- **设置系统**：自定义配置管理
- **认证系统**：匿名登录 + 激活码验证
- **激活码管理**：批量生成、状态查询、筛选统计（仅开发模式）
