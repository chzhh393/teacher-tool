# 更新日志

本文件记录幻兽学院项目的版本变更历史。

## v1.1.0 (2026-02-08)

### 新增
- **满级幻兽收集展示**：学生将幻兽养到满级后，该幻兽的究极形态会作为徽章记录在 `collectedBeasts` 字段中
  - 光荣榜每位学生右侧展示收集到的幻兽小图标（32px 圆形）
  - 鼠标悬停小图标时弹出放大预览（128px），显示幻兽名称
- **累计积分系统**：新增 `earnedScore` 字段，记录学生历史总获得积分
  - 只在加分时增加，不受兑换商品、领养新幻兽影响
  - 光荣榜排序改为：徽章数 → 累计积分（移除等级排序，因等级会随换幻兽重置）
- **进化庆祝动画优化**：幻兽升级弹出时先放大到 2 倍，短暂停留后缩回正常大小，增强视觉冲击力

### 变更
- **积分命名体系重构**，消除用户混淆：
  - 学生卡片进度条旁：「积分」→「成长值」（显示 totalScore，决定等级与进化）
  - 光荣榜：显示「累计积分」（earnedScore）和「可用积分」（availableScore）
  - 小卖部：「学生可用积分」→「可用积分」
  - 设置页成长阈值说明：「累计积分」→「累计成长值」
  - 光荣榜和小卖部头部新增说明文案，解释累计积分与可用积分的区别
- 云函数 `TT_score_batch`：加分时同步累加 `earnedScore`，满级时将当前 `beastId` 追加到 `collectedBeasts`
- 云函数 `TT_score_revoke`：撤回时同步扣减 `earnedScore`，撤回满级时移除最后收集的幻兽
- 云函数 `TT_honors_list`：排序规则从 徽章→等级→totalScore 改为 徽章→earnedScore

### 修复
- 修复领养新幻兽时 `availableScore` 不应被清零的问题（可用积分应永久累积）

## v1.0.9 (2026-02-07)

### 新增
- **自定义排序**：积分项、扣分项、小卖部商品均支持拖拽排序
  - 设置页面每个列表项左侧新增拖动手柄（⠿），长按拖拽即可调整顺序
  - 使用 framer-motion Reorder 组件实现，支持触摸设备
  - 加分项与扣分项独立排序，互不影响
  - 保存设置后，班级主页（加分/扣分弹窗）和小卖部页面按新顺序展示

### 变更
- 默认模板排序优化：按分值/价格从小到大排列
  - 加分项：1分（早读打卡、积极举手、课外阅读）→ 2分 → 3分
  - 扣分项：-1（迟到、打瞌睡）→ -2（课堂讲话、未交作业）
  - 小卖部商品：10分（铅笔）→ 15 → 20 → 30 → 40 → 50 → 60分（当一天班长）

## v1.0.8 (2026-02-07)

### 新增
- **满级收集循环机制**：幻兽达到满级（10级）后卡片显示"收集完成"状态，学生可领养新幻兽重新开始进化之旅
  - 满级卡片金色主题：等级标签显示"MAX"、金色渐变边框与进度条、"已收集完成"形态文字
  - 满级学生点击"领养新幻兽"按钮后自动重置等级与进化积分（totalScore/level/progress 归零），可用积分（availableScore）和徽章（badges）保留
- 云函数 `TT_score_batch` 增加 totalScore 封顶逻辑：加分时积分不超过当前班级设定的最高等级阈值，防止积分溢出

### 变更
- 新建班级的默认成长阈值从 `[0,5,12,22,35,50,65,80,90,100]` 调整为 `[0,5,12,22,35,50,70,95,125,160]`，与云函数默认值对齐（已有班级的自定义阈值不受影响）

## v1.0.7 (2026-02-07)

### 变更
- 领养幻兽弹窗默认展示蛋形态（原为幼年形态），让学生从孵蛋开始体验养成过程
- PWA 图标更换为幻兽蛋主题图标（`pwa-egg-192x192.png`、`pwa-egg-512x512.png`），删除旧占位图标
- 安装引导页面默认显示"电脑/希沃"教程（原默认 iPhone），Tab 顺序调整为：电脑/希沃 → iPhone/iPad → Android
- 安装引导电脑端教程增加希沃一体机说明，提示希沃自带浏览器可直接操作
- 登录页"安装应用到桌面"提示从文字链接改为卡片样式，更醒目

## v1.0.6 (2026-02-07)

### 新增
- **PWA 支持**：应用可安装到手机桌面或电脑，像原生 App 一样全屏使用
  - 集成 `vite-plugin-pwa`，自动生成 Service Worker 和 Web App Manifest
  - 离线缓存：静态资源预缓存（330+ 文件），幻兽图片 CacheFirst（30 天），API 请求 NetworkFirst（超时 5 秒降级缓存）
  - `index.html` 添加 `theme-color`、`apple-mobile-web-app-capable` 等 meta 标签
  - `main.tsx` 注册 Service Worker（autoUpdate 模式）
- **安装引导页面**（`/install-guide`）：分平台教用户安装到桌面
  - 支持电脑/希沃、iPhone/iPad、Android 三个平台切换
  - 每个平台 4 步图文教程，电脑端第 2 步附截图指示安装按钮位置
  - 包含微信/QQ 内打开的特别提示和浏览器兼容说明
- **登录页安装入口**：Auth 页面底部新增"安装应用到桌面"卡片式提示，点击跳转安装指南

### 变更
- `vite.config.ts` 添加 VitePWA 插件配置
- `tsconfig.app.json` 添加 `vite-plugin-pwa/client` 类型声明
- `App.tsx` 注册 `/install-guide` 公开路由

### 新增文件
- `app/src/routes/InstallGuide.tsx` — 安装指南页面
- `app/public/pwa-egg-192x192.png` — PWA 图标（幻兽蛋）
- `app/public/pwa-egg-512x512.png` — PWA 图标（幻兽蛋）
- `app/public/guide2.png` — 电脑端安装按钮截图

## v1.0.5 (2026-02-07)

### 新增
- 小卖部商品自定义：教师可在设置页面管理商品（增删改），商品按班级隔离
  - 支持编辑图标、名称、描述、价格、库存
  - 新班级首次访问设置页时自动初始化 8 个默认商品到数据库
  - 保存设置时并行保存积分规则和商品数据
- 新建云函数 `TT_shop_save`：批量同步商品（智能增/改/删）
- 兑换自动扣减库存：`TT_shop_redeem` 增加库存检查 + `db.command.inc(-1)` 原子扣减，库存为 0 时显示"售罄"

### 变更
- `TT_shop_list` 云函数增加 `classId` 过滤，商品从全局共享改为按班级隔离
- `TT_shop_items` 数据库集合新增 `classId` 字段
- Store 页面 `shopList` 调用传入当前班级 ID
- `normalizeShopItems` 工具函数增加 `data` 嵌套解包处理

### 修复
- 修复 `AppShell.tsx` 中 `setCloudStatus` 未定义的编译错误

## v1.0.4 (2026-02-07)

### 新增
- Excel 导入学生名单：支持上传 .xlsx/.xls 文件，自动识别姓名列，预览确认后批量导入
  - 三步流程：上传文件 → 选择姓名列（自动匹配"姓名"/"名字"等关键词）→ 预览去重后确认导入
  - 支持拖拽上传，文件大小限制 5MB
  - 新增 `ExcelImportModal` 组件和 `excelParse` 工具函数
  - 新增依赖 `xlsx`（SheetJS）

## v1.0.3 (2026-02-07)

### 新增
- 幻兽进化全屏庆祝动画：加分导致进化阶段变化时（蛋→幼年→少年→成年→究极），显示白色闪光 + 发光环 + 星星粒子 + 新形态幻兽居中展示 + 「已升级!」文字提示
- 批量操作时支持连续播放多个进化动画（最多 5 个），底部显示进度圆点
- 右上角「跳过」按钮或点击任意位置可跳过动画

### 优化
- 老师设置页面保存提示改为固定在视口顶部的 toast，成功提示 2.5 秒自动消失，增加关闭按钮

### 重构
- 将 `getEvolutionStage`、`stageNames` 提取到 `app/src/utils/evolution.ts` 共享工具函数

## v1.0.2 (2026-02-06)

### 修复
- 修复 Home 页「前往创建班级」链接使用 `<a>` 导致 SPA 路由 404 的问题，改用 `<Link>`
- 修复 `TT_student_list` 云函数全表扫描导致新班级学生不显示的问题（默认 100 条限制）
- 修复 `TT_class_get`、`TT_honors_list`、`TT_record_list`、`TT_record_export`、`TT_redeem_list`、`TT_class_list` 共 6 个云函数相同的全表扫描问题，统一改为 `.where()` + `.limit(1000)`

### 新增
- 新用户创建班级后自动预置 13 条默认积分规则（9 加分 + 4 减分），数据来源于 3年3班配置
- 未领养幻兽的学生在加分/减分操作时显示 toast 提示「XX还没有领养幻兽，请先领养」，覆盖单个、批量、全班三种操作模式

### 变更
- Toast 提示位置调整为屏幕下方 1/3 处

## v1.0.1 (2026-02-06)

### 修复
- 修复激活码管理页面"已使用"状态筛选返回空结果的问题
- 将 BrowserRouter 切换为 HashRouter，解决静态托管下页面刷新 404 问题

### 变更
- 移除页面标题中的个人姓名
- 更新部署文档，补充故障排查指南

## v1.0.0 (2026-02-05)

### 功能
- **幻兽系统**：30 只幻兽，5 个进化阶段，10 个等级
- **积分系统**：加分/减分操作，积分记录追踪
- **商店系统**：积分兑换道具
- **荣誉系统**：荣誉授予与展示
- **记录系统**：操作历史查看
- **设置系统**：自定义配置管理
- **认证系统**：匿名登录 + 激活码验证
- **激活码管理**：批量生成、状态查询、筛选统计（仅开发模式）
