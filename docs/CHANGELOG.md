# 更新日志

本文件记录幻兽学院项目的版本变更历史。

## v1.5.4 (2026-02-10)

### 修复
- **修复加分提示显示错误学生名**：加分/扣分后底部撤回栏显示的学生姓名与实际操作的学生不一致（如显示"33"而非真实姓名）。根因：操作后立即查 `TT_record_list` 获取最新记录，但数据库一致性延迟导致查到其他学生的旧记录。改为直接使用前端本地数据（学生姓名+规则名+分值）构建提示信息
- **修复成长记录排序错误**：成长记录按日期排序时，2月10日的记录排在2月9日后面。根因：`TT_record_list` 云函数先将时间戳格式化为 `"2026/2/10"` 再做字符串排序，单位数日期 `"9"` > `"1"` 导致排序错误。改为使用原始时间戳数值排序

### 优化
- **成长记录查询性能优化**：`TT_record_list` 云函数重构
  - 排序：内存字符串排序 → 数据库端 `orderBy` 排序
  - 分页：全量加载 1000 条切片 → 数据库端 `skip/limit` 分页
  - 总数：加载全部取 `.length` → `count()` 查询
  - 查询：单路径 `data.classId` → `_.or()` 双路径兼容
  - 索引：新增 `TT_score_records` 集合复合索引（`data.classId` + `data.createdAt` 降序）
  - 突破原 1000 条硬上限，数据量增长不影响性能

## v1.5.3 (2026-02-10)

### 修复
- **修复学生添加按钮可重复点击**：添加、批量添加、Excel 导入三个按钮在操作进行中未禁用，用户连续快速点击会导致同一批学生被重复写入多次（实际案例：一个班级出现 600 条重复学生记录）。三个按钮均添加 `disabled={loading}` 防重复提交

### 运维
- **清理重复学生数据**：删除用户 `xiaoxuetongxue` 的重复班级 `class-1770688135019`（600 条重复学生 + 63 条积分记录 + 班级设置），保留正常班级 `class-1770688201239`（50 名学生）

## v1.5.2 (2026-02-10)

### 改进
- **手机端成长记录入口**：主账号手机端底部导航新增「记录」Tab（原仅子账号可见），与 PC 端导航一致
- **成长记录页手机端适配**：标题、搜索框、记录列表、分页控件响应式优化，文字和间距在小屏幕上更紧凑，长文本自动截断防溢出

## v1.5.1 (2026-02-10)

### 修复
- **修复触屏设备点击学生卡片无反应**：360浏览器+智慧黑板等触屏设备上，hover 效果（`hover:-translate-y-1`）导致卡片位移，浏览器取消 click 事件。三层防护：Tailwind `hoverOnlyWhenSupported`、CSS `@media (pointer: coarse)` 兜底、`touch-action: manipulation`

## v1.5.0 (2026-02-10)

### 新增
- **小组积分PK**：老师可将学生分组进行积分PK竞赛，小组积分 = 成员累计积分之和
  - 设置页新增「分组管理」Tab：创建小组、设置颜色标识、勾选成员、整体保存
  - 光荣榜新增「小组PK」Tab：按小组总积分降序排名，展示人数、人均分，可展开查看成员明细
  - 无小组时保持原样，有小组时自动显示 Tab 切换（向后兼容）
- 新增云函数：`TT_group_manage`（list/save 两个 action）
- 新增数据库集合：`TT_groups`
- 新增前端组件：`GroupManager.tsx`（分组管理）
- `TT_class_delete` 新增小组归档和级联删除
- `TT_student_delete` 删除学生时自动从所属小组移除

## v1.4.2 (2026-02-10)

### 修复
- **修复光荣榜小组排名可能崩溃**：`TT_honors_list` 查询 `TT_groups` 集合未加 try-catch，集合不存在时整个函数报错。新增 try-catch 兜底，集合不存在时安全返回空小组排名
- **修复光荣榜切换班级残留旧数据**：`Honors.tsx` 的 useEffect 在 classId 变化时未先清空 ranks 和 groupRanks，短暂显示上一班级的排名数据
- **修复子账号创建用户名校验全表扫描**：`TT_subaccount_manage` 校验用户名唯一性时用 `.get()` 无 `.where()` 无 `.limit()` 全表扫描，用户超 100 人后可能误判重名。改为 `_.or()` 双路径精确查询
- **修复 `TT_settings_save` session 查询缺少 `.limit(1)`**：verifyToken 中两处 `.where().get()` 缺少 `.limit(1)`，与其他云函数不一致
- **新建 `TT_groups` 数据库集合**：小组管理功能依赖的集合未在 CloudBase 创建，导致光荣榜小组排名、删除班级级联清理、删除学生移出小组等功能查询时可能报错

## v1.4.1 (2026-02-10)

### 新增
- **班级学生人数上限**：每个班级最多 100 名学生
  - 云函数 `TT_student_upsert` 新增后端校验：新建学生前检查班级现有人数，达到 100 人时拒绝添加
  - 前端三个添加入口（单个添加、批量文本导入、Excel 导入）均增加前端校验，提前拦截并提示剩余名额
  - 学生管理区域显示 `当前学生 (N/100)`，达上限时显示红色"已达上限"标签

## v1.4.0 (2026-02-10)

### 新增
- **进度分享到家长群**：老师生成分享链接发到微信群，家长点开即可查看幻兽养成实时进度，无需登录
  - 支持两种分享模式：班级概览（全班卡片网格）和学生详情（单个学生大图）
  - 班级概览：2列卡片，显示排名奖牌、学生名、等级、幻兽形态、进度条
  - 学生详情：幻兽大图、三格数据（徽章/累计积分/可用积分）、已收集幻兽、最近积分记录
  - 前3名金/银/铜高亮，满级学生显示收集完成标记
  - 分享链接默认30天有效，支持手动撤销
  - 首页操作栏新增"分享家长"按钮，弹窗内可创建分享、复制链接、管理已有分享
- 新增云函数：`TT_share_create`（创建/列出/撤销分享令牌）、`TT_share_view`（公开查看分享数据）
- 新增数据库集合：`TT_shares`
- 新增前端组件：`ShareView.tsx`（公开分享页）、`ShareModal.tsx`（老师端分享弹窗）
- 新增公开路由：`/s/:token`（不需要登录）

### 修复
- 修复新建班级"从已有班级复制"时，新班级短暂显示源班级学生列表的问题（`setStudents([])` 移至 `setClass()` 之后、`await` 之前，避免中间渲染旧数据）
- **修复删除班级报错**：`TT_archive` 集合未创建导致归档写入失败，删除操作被中止
- **修复删除班级未清理设置**：`TT_class_delete` 引用了错误的集合名 `TT_class_settings`（实际应为 `TT_settings`），导致班级设置既未归档也未删除
- **修复删除班级后子账号脏数据**：删除班级时未清理子账号 `authorizedClassIds` 中对该班级的引用
- **修复删除班级大数据量风险**：积分记录超过 5000 条时自动分片归档，避免单文档超出 16MB 限制
- **修复复制班级设置无效**：`...sourceSettings` 展开将源班级的 `_id`、`classId`、嵌套 `data` 等字段带入新设置，在 `TT_settings_save` 中覆盖了正确的 `_id` 和 `classId`（变为 `undefined`），导致后续 `refresh` 读不到设置而写入默认值。改为显式提取 `systemName`、`themeColor`、`scoreRules`、`levelThresholds` 四个字段
- **修复 `TT_settings_save` 字段覆盖**：云函数保存前先剔除 `_id`、`classId`、`data`、`createdAt`、`updatedAt`，确保这些字段由云函数自身生成，不被前端传入值覆盖

## v1.3.0 (2026-02-10)

### 新增
- **手机端适配**：老师可在手机上快速给学生加减分
  - 底部 Tab 导航栏（首页/光荣榜/小卖部/设置），拇指友好
  - 顶部导航在手机端精简，只保留 logo、班级切换和退出
  - 学生卡片手机端 2 列紧凑布局，一屏可看 4-6 个学生
  - 卡片顶部一行显示：名字、等级、幻兽名、形态
  - 手机端未领养和满级学生显示领养按钮
  - 弹窗改为底部抽屉模式，从屏幕底部滑出
  - 积分规则弹窗 2 列显示，图标+名称+分值一行排列
  - 适配 iPhone 底部安全区（safe-area）
  - 所有改动通过 `md:` 断点隔离，桌面端完全不受影响

### 优化
- **设置页文案优化**："批量导入"改为"批量添加"，与 Excel 导入区分
- **小卖部商品编辑**：手机端分两行显示（名称行 + 描述/价格/库存行），价格库存输入框缩小
- **积分规则编辑**：手机端强制一行显示，不再换行
- **全班操作按钮**：样式改为普通按钮（btn-default），不再高亮突出

### 修复
- 切换班级时学生卡片未刷新：切换时立即清空旧数据再加载
- 学生 id 为空时 key 重复的 React 警告
- 单个学生加分时可能误触发全班操作的逻辑问题

## v1.2.1 (2026-02-09)

### 优化
- **设置页自动保存**：修改积分规则、成长阈值、小卖部商品后自动保存，无需手动点击保存按钮
  - 编辑后 1.5 秒无操作自动触发保存
  - 顶部导航栏右侧显示保存状态（保存中 / 已保存 / 保存失败）
  - 新增规则或商品名称为空时暂不保存，填写完成后自动触发
  - 移除页面底部"保存设置"按钮

## v1.2.0 (2026-02-09)

### 新增
- **子账号系统**：主账号可创建子账号，支持班干部代管和多老师协作两大场景
  - 主账号在"设置 → 子账号管理"中创建/编辑/删除子账号
  - 子账号设置用户名、密码、昵称，勾选授权班级
  - 子账号登录后仅看到授权的班级，可加分/减分，操作留痕
  - 子账号无权管理班级、学生名单、积分规则、幻兽领养等
  - 导航栏子账号显示"子账号"角色标签，隐藏"老师设置"入口
  - 积分记录显示操作人信息（operatorName）
- **小卖部兑换权限可配置**：创建/编辑子账号时可勾选"允许兑换小卖部商品"
  - 默认关闭（班干部场景），开启后子账号可在授权班级内为学生兑换商品
  - 未开启时小卖部页面可浏览但商品卡片显示"仅查看"
- **全面鉴权补齐**：原有 11 个无鉴权云函数统一补充 token 鉴权 + 角色权限控制
- 新增云函数：`TT_subaccount_manage`（list/create/update/delete）
- 修改云函数（24 个）：`TT_auth_login`、`TT_auth_verify`、`TT_auth_register`、`TT_auth_activate`、`TT_class_list`、`TT_class_get`、`TT_class_upsert`、`TT_class_delete`、`TT_score_batch`、`TT_score_revoke`、`TT_record_list`、`TT_record_export`、`TT_honors_list`、`TT_settings_get`、`TT_settings_save`、`TT_student_list`、`TT_student_upsert`、`TT_student_delete`、`TT_shop_list`、`TT_shop_save`、`TT_shop_redeem`、`TT_redeem_list`
- 新增前端组件：`SubAccountManager.tsx`

### 数据模型变更
- `TT_users` 新增字段：`role`、`nickname`、`parentUserId`、`authorizedClassIds`、`canRedeem`
- `TT_sessions` 新增字段：`role`、`nickname`、`authorizedClassIds`、`canRedeem`
- `TT_score_records` 新增字段：`operatorId`、`operatorName`

## v1.1.2 (2026-02-08)

### 新增
- **新建班级复制已有班级设置**：新建班级弹窗新增"初始设置"选择器
  - 「默认模板」：使用系统预设的积分规则和商品（原有行为）
  - 「从已有班级复制」：选择一个已有班级，复制其积分规则、成长阈值和小卖部商品到新班级
  - 无已有班级时复制选项自动禁用
  - 创建后仍可在设置页面继续修改

## v1.1.1 (2026-02-08)

### 新增
- **成长记录按学生搜索**：记录页面顶部新增搜索框，输入学生姓名可筛选该学生的所有积分记录
  - 支持模糊匹配（输入"张"可匹配"张子涵"）
  - 支持回车搜索，搜索后自动回到第一页
  - 搜索状态下显示"清除"按钮，一键恢复全部记录
  - 云函数 `TT_record_list` 新增 `studentName` 过滤参数
- **设置保存校验**：保存设置时校验积分规则名称和小卖部商品名称不能为空，为空时提示错误并阻止保存

## v1.1.0 (2026-02-08)

### 新增
- **满级幻兽收集展示**：学生将幻兽养到满级后，该幻兽的究极形态会作为徽章记录在 `collectedBeasts` 字段中
  - 光荣榜每位学生右侧展示收集到的幻兽小图标（32px 圆形）
  - 鼠标悬停小图标时弹出放大预览（128px），显示幻兽名称
- **累计积分系统**：新增 `earnedScore` 字段，记录学生历史总获得积分
  - 只在加分时增加，不受兑换商品、领养新幻兽影响
  - 光荣榜排序改为：徽章数 → 累计积分（移除等级排序，因等级会随换幻兽重置）
- **进化庆祝动画优化**：幻兽升级弹出时先放大到 2 倍，短暂停留后缩回正常大小，增强视觉冲击力

### 变更
- **积分命名体系重构**，消除用户混淆：
  - 学生卡片进度条旁：「积分」→「成长值」（显示 totalScore，决定等级与进化）
  - 光荣榜：显示「累计积分」（earnedScore）和「可用积分」（availableScore）
  - 小卖部：「学生可用积分」→「可用积分」
  - 设置页成长阈值说明：「累计积分」→「累计成长值」
  - 光荣榜和小卖部头部新增说明文案，解释累计积分与可用积分的区别
- 云函数 `TT_score_batch`：加分时同步累加 `earnedScore`，满级时将当前 `beastId` 追加到 `collectedBeasts`
- 云函数 `TT_score_revoke`：撤回时同步扣减 `earnedScore`，撤回满级时移除最后收集的幻兽
- 云函数 `TT_honors_list`：排序规则从 徽章→等级→totalScore 改为 徽章→earnedScore

### 修复
- 修复领养新幻兽时 `availableScore` 不应被清零的问题（可用积分应永久累积）

## v1.0.9 (2026-02-07)

### 新增
- **自定义排序**：积分项、扣分项、小卖部商品均支持拖拽排序
  - 设置页面每个列表项左侧新增拖动手柄（⠿），长按拖拽即可调整顺序
  - 使用 framer-motion Reorder 组件实现，支持触摸设备
  - 加分项与扣分项独立排序，互不影响
  - 保存设置后，班级主页（加分/扣分弹窗）和小卖部页面按新顺序展示

### 变更
- 默认模板排序优化：按分值/价格从小到大排列
  - 加分项：1分（早读打卡、积极举手、课外阅读）→ 2分 → 3分
  - 扣分项：-1（迟到、打瞌睡）→ -2（课堂讲话、未交作业）
  - 小卖部商品：10分（铅笔）→ 15 → 20 → 30 → 40 → 50 → 60分（当一天班长）

## v1.0.8 (2026-02-07)

### 新增
- **满级收集循环机制**：幻兽达到满级（10级）后卡片显示"收集完成"状态，学生可领养新幻兽重新开始进化之旅
  - 满级卡片金色主题：等级标签显示"MAX"、金色渐变边框与进度条、"已收集完成"形态文字
  - 满级学生点击"领养新幻兽"按钮后自动重置等级与进化积分（totalScore/level/progress 归零），可用积分（availableScore）和徽章（badges）保留
- 云函数 `TT_score_batch` 增加 totalScore 封顶逻辑：加分时积分不超过当前班级设定的最高等级阈值，防止积分溢出

### 变更
- 新建班级的默认成长阈值从 `[0,5,12,22,35,50,65,80,90,100]` 调整为 `[0,5,12,22,35,50,70,95,125,160]`，与云函数默认值对齐（已有班级的自定义阈值不受影响）

## v1.0.7 (2026-02-07)

### 变更
- 领养幻兽弹窗默认展示蛋形态（原为幼年形态），让学生从孵蛋开始体验养成过程
- PWA 图标更换为幻兽蛋主题图标（`pwa-egg-192x192.png`、`pwa-egg-512x512.png`），删除旧占位图标
- 安装引导页面默认显示"电脑/希沃"教程（原默认 iPhone），Tab 顺序调整为：电脑/希沃 → iPhone/iPad → Android
- 安装引导电脑端教程增加希沃一体机说明，提示希沃自带浏览器可直接操作
- 登录页"安装应用到桌面"提示从文字链接改为卡片样式，更醒目

## v1.0.6 (2026-02-07)

### 新增
- **PWA 支持**：应用可安装到手机桌面或电脑，像原生 App 一样全屏使用
  - 集成 `vite-plugin-pwa`，自动生成 Service Worker 和 Web App Manifest
  - 离线缓存：静态资源预缓存（330+ 文件），幻兽图片 CacheFirst（30 天），API 请求 NetworkFirst（超时 5 秒降级缓存）
  - `index.html` 添加 `theme-color`、`apple-mobile-web-app-capable` 等 meta 标签
  - `main.tsx` 注册 Service Worker（autoUpdate 模式）
- **安装引导页面**（`/install-guide`）：分平台教用户安装到桌面
  - 支持电脑/希沃、iPhone/iPad、Android 三个平台切换
  - 每个平台 4 步图文教程，电脑端第 2 步附截图指示安装按钮位置
  - 包含微信/QQ 内打开的特别提示和浏览器兼容说明
- **登录页安装入口**：Auth 页面底部新增"安装应用到桌面"卡片式提示，点击跳转安装指南

### 变更
- `vite.config.ts` 添加 VitePWA 插件配置
- `tsconfig.app.json` 添加 `vite-plugin-pwa/client` 类型声明
- `App.tsx` 注册 `/install-guide` 公开路由

### 新增文件
- `app/src/routes/InstallGuide.tsx` — 安装指南页面
- `app/public/pwa-egg-192x192.png` — PWA 图标（幻兽蛋）
- `app/public/pwa-egg-512x512.png` — PWA 图标（幻兽蛋）
- `app/public/guide2.png` — 电脑端安装按钮截图

## v1.0.5 (2026-02-07)

### 新增
- 小卖部商品自定义：教师可在设置页面管理商品（增删改），商品按班级隔离
  - 支持编辑图标、名称、描述、价格、库存
  - 新班级首次访问设置页时自动初始化 8 个默认商品到数据库
  - 保存设置时并行保存积分规则和商品数据
- 新建云函数 `TT_shop_save`：批量同步商品（智能增/改/删）
- 兑换自动扣减库存：`TT_shop_redeem` 增加库存检查 + `db.command.inc(-1)` 原子扣减，库存为 0 时显示"售罄"

### 变更
- `TT_shop_list` 云函数增加 `classId` 过滤，商品从全局共享改为按班级隔离
- `TT_shop_items` 数据库集合新增 `classId` 字段
- Store 页面 `shopList` 调用传入当前班级 ID
- `normalizeShopItems` 工具函数增加 `data` 嵌套解包处理

### 修复
- 修复 `AppShell.tsx` 中 `setCloudStatus` 未定义的编译错误

## v1.0.4 (2026-02-07)

### 新增
- Excel 导入学生名单：支持上传 .xlsx/.xls 文件，自动识别姓名列，预览确认后批量导入
  - 三步流程：上传文件 → 选择姓名列（自动匹配"姓名"/"名字"等关键词）→ 预览去重后确认导入
  - 支持拖拽上传，文件大小限制 5MB
  - 新增 `ExcelImportModal` 组件和 `excelParse` 工具函数
  - 新增依赖 `xlsx`（SheetJS）

## v1.0.3 (2026-02-07)

### 新增
- 幻兽进化全屏庆祝动画：加分导致进化阶段变化时（蛋→幼年→少年→成年→究极），显示白色闪光 + 发光环 + 星星粒子 + 新形态幻兽居中展示 + 「已升级!」文字提示
- 批量操作时支持连续播放多个进化动画（最多 5 个），底部显示进度圆点
- 右上角「跳过」按钮或点击任意位置可跳过动画

### 优化
- 老师设置页面保存提示改为固定在视口顶部的 toast，成功提示 2.5 秒自动消失，增加关闭按钮

### 重构
- 将 `getEvolutionStage`、`stageNames` 提取到 `app/src/utils/evolution.ts` 共享工具函数

## v1.0.2 (2026-02-06)

### 修复
- 修复 Home 页「前往创建班级」链接使用 `<a>` 导致 SPA 路由 404 的问题，改用 `<Link>`
- 修复 `TT_student_list` 云函数全表扫描导致新班级学生不显示的问题（默认 100 条限制）
- 修复 `TT_class_get`、`TT_honors_list`、`TT_record_list`、`TT_record_export`、`TT_redeem_list`、`TT_class_list` 共 6 个云函数相同的全表扫描问题，统一改为 `.where()` + `.limit(1000)`

### 新增
- 新用户创建班级后自动预置 13 条默认积分规则（9 加分 + 4 减分），数据来源于 3年3班配置
- 未领养幻兽的学生在加分/减分操作时显示 toast 提示「XX还没有领养幻兽，请先领养」，覆盖单个、批量、全班三种操作模式

### 变更
- Toast 提示位置调整为屏幕下方 1/3 处

## v1.0.1 (2026-02-06)

### 修复
- 修复激活码管理页面"已使用"状态筛选返回空结果的问题
- 将 BrowserRouter 切换为 HashRouter，解决静态托管下页面刷新 404 问题

### 变更
- 移除页面标题中的个人姓名
- 更新部署文档，补充故障排查指南

## v1.0.0 (2026-02-05)

### 功能
- **幻兽系统**：30 只幻兽，5 个进化阶段，10 个等级
- **积分系统**：加分/减分操作，积分记录追踪
- **商店系统**：积分兑换道具
- **荣誉系统**：荣誉授予与展示
- **记录系统**：操作历史查看
- **设置系统**：自定义配置管理
- **认证系统**：匿名登录 + 激活码验证
- **激活码管理**：批量生成、状态查询、筛选统计（仅开发模式）
